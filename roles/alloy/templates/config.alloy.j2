//-- Targets
loki.write "loki" {
	endpoint {
		url = "http://{{ loki_host }}:3100/loki/api/v1/push"
	}
	external_labels = {}
}

prometheus.remote_write "victoriametrics" {
	endpoint {
		url = "http://{{ victoriametrics_host }}:8428/api/v1/write"
	}
}
//-- End Targets

//-- Begin Local File logs
local.file_match "local_files" {
	path_targets = [{"__path__" = "/var/log/*.log"}]
	sync_period = "5s"
}

loki.source.file "log_scrape" {
	targets			= local.file_match.local_files.targets
	forward_to		= [loki.process.filter_logs.receiver]
	tail_from_end	= true
}

loki.process "filter_logs" {
	stage.static_labels {
		values = {
			job = "system logs",
			instance = constants.hostname,
		}
	}
	forward_to	= [loki.write.loki.receiver]
}
//-- End File logs

//-- Begin docker logs
discovery.docker "docker" {
  host = "unix:///var/run/docker.sock"
}

discovery.relabel "logs_integrations_docker" {
  targets = []

  rule {
    source_labels = ["__meta_docker_container_name"]
    regex = "/(.*)"
    target_label = "service_name"
  }
}

loki.source.docker "local" {
  host       = "unix:///var/run/docker.sock"
  targets    = discovery.docker.docker.targets
  labels     = {"platform" = "docker"}
  relabel_rules = discovery.relabel.logs_integrations_docker.rules
  forward_to = [loki.write.loki.receiver]
}
//-- End docker logs

//-- Node Exporter
discovery.relabel "integrations_node_exporter" {
  targets = prometheus.exporter.unix.integrations_node_exporter.targets

  rule {
    target_label = "instance"
    replacement  = constants.hostname
  }

  rule {
    target_label = "job"
    replacement = "integrations/node_exporter"
  }
}

prometheus.exporter.unix "integrations_node_exporter" {
  disable_collectors = ["ipvs", "btrfs", "infiniband", "xfs", "zfs"]
  set_collectors = [
	"cpu",
	"memory",
	"disk",
	"network",
	"system",
  ]
  filesystem {
    fs_types_exclude     = "^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|tmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$"
    mount_points_exclude = "^/(dev|proc|run/credentials/.+|sys|var/lib/docker/.+)($|/)"
    mount_timeout        = "5s"
  }

  netclass {
    ignored_devices = "^(veth.*|cali.*|[a-f0-9]{15})$"
  }

  netdev {
    device_exclude = "^(veth.*|cali.*|[a-f0-9]{15})$"
  }
}

prometheus.scrape "integrations_node_exporter" {
	targets    = discovery.relabel.integrations_node_exporter.output
	forward_to = [prometheus.remote_write.victoriametrics.receiver]
	job_name   = "integrations/node_exporter"
}
//-- End Node Exporter
